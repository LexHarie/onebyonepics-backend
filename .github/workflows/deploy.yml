name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # Deployment config
      IMAGE_NAME: ${{ secrets.DO_IMAGE_NAME || 'onebyonepics-backend' }}
      IMAGE_TAG: ${{ secrets.DO_IMAGE_TAG || 'latest' }}
      CONTAINER_NAME: ${{ secrets.DO_CONTAINER_NAME || 'onebyonepics-backend' }}
      DOCKER_RUN_FLAGS: ${{ secrets.DO_DOCKER_RUN_FLAGS || '-d --restart unless-stopped -p 3000:3000' }}
      IMAGE_TAR: onebyonepics-image.tar
      DEPLOY_PATH: ${{ secrets.DO_DEPLOY_PATH || '/tmp/onebyonepics-deploy' }}
      # App config
      PORT: ${{ secrets.PORT || '3000' }}
      API_PREFIX: ${{ secrets.API_PREFIX || 'api' }}
      # Database
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      # JWT
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
      JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN || '900s' }}
      JWT_REFRESH_EXPIRES_IN: ${{ secrets.JWT_REFRESH_EXPIRES_IN || '7d' }}
      # Google GenAI
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      GOOGLE_GENAI_MODEL: ${{ secrets.GOOGLE_GENAI_MODEL || 'gemini-2.0-flash-exp' }}
      # DigitalOcean Spaces
      DO_SPACES_KEY: ${{ secrets.DO_SPACES_KEY }}
      DO_SPACES_SECRET: ${{ secrets.DO_SPACES_SECRET }}
      DO_SPACES_REGION: ${{ secrets.DO_SPACES_REGION || 'sgp1' }}
      DO_SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET || 'onebyonepics-s3' }}
      DO_SPACES_CDN_ENDPOINT: ${{ secrets.DO_SPACES_CDN_ENDPOINT }}
      # Other
      CORS_ORIGIN: ${{ secrets.CORS_ORIGIN || 'http://localhost:5173' }}
      CLEANUP_ORIGINAL_IMAGES_HOURS: ${{ secrets.CLEANUP_ORIGINAL_IMAGES_HOURS || '24' }}
      CLEANUP_GENERATED_IMAGES_DAYS: ${{ secrets.CLEANUP_GENERATED_IMAGES_DAYS || '7' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build container image
        run: |
          docker build --tag "$IMAGE_NAME:$IMAGE_TAG" .

      - name: Save image archive
        run: |
          docker save "$IMAGE_NAME:$IMAGE_TAG" -o "$IMAGE_TAR"

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

      - name: Add droplet to known hosts
        run: |
          mkdir -p ~/.ssh
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          if [ -n "$PORT" ]; then
            ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
          fi

      - name: Create env file
        run: |
          cat <<EOF > deploy.env
          PORT=${PORT}
          API_PREFIX=${API_PREFIX}
          DATABASE_URL=${DATABASE_URL}
          JWT_SECRET=${JWT_SECRET}
          JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
          JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
          JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN}
          GOOGLE_API_KEY=${GOOGLE_API_KEY}
          GOOGLE_GENAI_MODEL=${GOOGLE_GENAI_MODEL}
          DO_SPACES_KEY=${DO_SPACES_KEY}
          DO_SPACES_SECRET=${DO_SPACES_SECRET}
          DO_SPACES_REGION=${DO_SPACES_REGION}
          DO_SPACES_BUCKET=${DO_SPACES_BUCKET}
          DO_SPACES_CDN_ENDPOINT=${DO_SPACES_CDN_ENDPOINT}
          CORS_ORIGIN=${CORS_ORIGIN}
          CLEANUP_ORIGINAL_IMAGES_HOURS=${CLEANUP_ORIGINAL_IMAGES_HOURS}
          CLEANUP_GENERATED_IMAGES_DAYS=${CLEANUP_GENERATED_IMAGES_DAYS}
          EOF
          # Remove leading whitespace from each line
          sed -i 's/^[[:space:]]*//' deploy.env

      - name: Ensure remote directory
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SSH_ARGS=""
          if [ -n "$PORT" ]; then
            SSH_ARGS="-p $PORT"
          fi
          ssh $SSH_ARGS "$TARGET" "mkdir -p \"$DEPLOY_PATH\""

      - name: Upload env file
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SCP_PORT=""
          if [ -n "$PORT" ]; then
            SCP_PORT="-P $PORT"
          fi
          scp $SCP_PORT deploy.env "$TARGET:$DEPLOY_PATH/.env"

      - name: Upload image archive
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SCP_PORT=""
          if [ -n "$PORT" ]; then
            SCP_PORT="-P $PORT"
          fi
          scp $SCP_PORT "$IMAGE_TAR" "$TARGET:$DEPLOY_PATH/$IMAGE_TAR"

      - name: Deploy container on droplet
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SSH_ARGS=""
          if [ -n "$PORT" ]; then
            SSH_ARGS="-p $PORT"
          fi
          ssh $SSH_ARGS "$TARGET" "
            set -euo pipefail
            IMAGE_TAR_PATH=\"$DEPLOY_PATH/$IMAGE_TAR\"
            ENV_FILE_PATH=\"$DEPLOY_PATH/.env\"

            echo '=== Stopping old container ==='
            docker stop \"$CONTAINER_NAME\" >/dev/null 2>&1 || true
            docker rm \"$CONTAINER_NAME\" >/dev/null 2>&1 || true

            echo '=== Cleaning up Docker resources ==='
            # Remove all stopped containers
            docker container prune -f || true
            # Remove dangling images (untagged)
            docker image prune -f || true
            # Remove unused images not referenced by any container
            docker image prune -a -f --filter \"until=24h\" || true
            # Remove unused volumes
            docker volume prune -f || true
            # Remove unused networks
            docker network prune -f || true
            # Clear build cache older than 24h
            docker builder prune -f --filter \"until=24h\" || true

            echo '=== Loading new image ==='
            docker load -i \"\$IMAGE_TAR_PATH\"

            echo '=== Running database migrations ==='
            docker run --rm --env-file \"\$ENV_FILE_PATH\" \"$IMAGE_NAME:$IMAGE_TAG\" bun run migrate

            echo '=== Validating database schema ==='
            docker run --rm --env-file \"\$ENV_FILE_PATH\" \"$IMAGE_NAME:$IMAGE_TAG\" bun run schema:validate

            echo '=== Starting new container ==='
            docker run $DOCKER_RUN_FLAGS --name \"$CONTAINER_NAME\" --env-file \"\$ENV_FILE_PATH\" \"$IMAGE_NAME:$IMAGE_TAG\"

            echo '=== Cleanup ==='
            rm -f \"\$IMAGE_TAR_PATH\"

            echo '=== Deployment complete ==='
            docker ps | grep \"$CONTAINER_NAME\" || echo 'Warning: Container may not be running'
          "
