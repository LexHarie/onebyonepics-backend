name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ secrets.DO_IMAGE_NAME || 'onebyonepics-backend' }}
      IMAGE_TAG: ${{ secrets.DO_IMAGE_TAG || 'latest' }}
      CONTAINER_NAME: ${{ secrets.DO_CONTAINER_NAME || 'onebyonepics-backend' }}
      DOCKER_RUN_FLAGS: ${{ secrets.DO_DOCKER_RUN_FLAGS || '-d --restart unless-stopped -p 3000:3000' }}
      IMAGE_TAR: onebyonepics-image.tar
      DEPLOY_PATH: ${{ secrets.DO_DEPLOY_PATH || '/tmp/onebyonepics-deploy' }}
      DOCKER_ENV_FILE: ${{ secrets.DO_DOCKER_ENV_FILE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build container image
        run: |
          docker build --tag "$IMAGE_NAME:$IMAGE_TAG" .

      - name: Save image archive
        run: |
          docker save "$IMAGE_NAME:$IMAGE_TAG" -o "$IMAGE_TAR"

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.DO_SSH_PRIVATE_KEY }}

      - name: Add droplet to known hosts
        run: |
          mkdir -p ~/.ssh
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          if [ -n "$PORT" ]; then
            ssh-keyscan -p "$PORT" -H "$HOST" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
          fi

      - name: Create env file
        run: |
          cat <<EOF > deploy.env
          PORT=${PORT}
          API_PREFIX=${API_PREFIX}
          DATABASE_URL=${DATABASE_URL}
          JWT_SECRET=${JWT_SECRET}
          JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
          JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
          JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN}
          GOOGLE_API_KEY=${GOOGLE_API_KEY}
          GOOGLE_GENAI_MODEL=${GOOGLE_GENAI_MODEL}
          DO_SPACES_KEY=${DO_SPACES_KEY}
          DO_SPACES_SECRET=${DO_SPACES_SECRET}
          DO_SPACES_REGION=${DO_SPACES_REGION}
          DO_SPACES_BUCKET=${DO_SPACES_BUCKET}
          DO_SPACES_CDN_ENDPOINT=${DO_SPACES_CDN_ENDPOINT}
          CORS_ORIGIN=${CORS_ORIGIN}
          CLEANUP_ORIGINAL_IMAGES_HOURS=${CLEANUP_ORIGINAL_IMAGES_HOURS}
          CLEANUP_GENERATED_IMAGES_DAYS=${CLEANUP_GENERATED_IMAGES_DAYS}
          EOF

      - name: Ensure remote directory
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SSH_ARGS=""
          if [ -n "$PORT" ]; then
            SSH_ARGS="-p $PORT"
          fi
          ssh $SSH_ARGS "$TARGET" "mkdir -p \"$DEPLOY_PATH\""

      - name: Upload env file
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SCP_PORT=""
          if [ -n "$PORT" ]; then
            SCP_PORT="-P $PORT"
          fi
          scp $SCP_PORT deploy.env "$TARGET:$DEPLOY_PATH/.env"

      - name: Upload image archive
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SCP_PORT=""
          if [ -n "$PORT" ]; then
            SCP_PORT="-P $PORT"
          fi
          scp $SCP_PORT "$IMAGE_TAR" "$TARGET:$DEPLOY_PATH/$IMAGE_TAR"

      - name: Deploy container on droplet
        run: |
          USER="${{ secrets.DO_USER }}"
          HOST="${{ secrets.DO_HOST }}"
          PORT="${{ secrets.DO_SSH_PORT }}"
          TARGET="$USER@$HOST"
          SSH_ARGS=""
          if [ -n "$PORT" ]; then
            SSH_ARGS="-p $PORT"
          fi
          ssh $SSH_ARGS "$TARGET" "
            set -euo pipefail
            IMAGE_TAR_PATH=\"$DEPLOY_PATH/$IMAGE_TAR\"
            ENV_FILE_PATH=\"$DEPLOY_PATH/.env\"
            docker load -i \"\$IMAGE_TAR_PATH\"
            docker stop \"$CONTAINER_NAME\" >/dev/null 2>&1 || true
            docker rm \"$CONTAINER_NAME\" >/dev/null 2>&1 || true
            docker run $DOCKER_RUN_FLAGS --name \"$CONTAINER_NAME\" --env-file \"\$ENV_FILE_PATH\" \"$IMAGE_NAME:$IMAGE_TAG\"
            rm -f \"\$IMAGE_TAR_PATH\"
          "
